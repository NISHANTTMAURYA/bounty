{% extends 'base.html' %}

{% block content %}
<div class="chat-container">
    <div class="chat-messages" id="chat-messages">
        {% for message in messages %}
            <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                <p>{{ message.content }}</p>
                <small>{{ message.timestamp|date:"g:i A" }}</small>
            </div>
        {% endfor %}
    </div>
    
    <div class="chat-input">
        <input type="text" id="chat-message-input" placeholder="Type your message...">
        <button id="chat-message-submit">Send</button>
    </div>
</div>

<script>
    const roomName = {{ room.id }};
    const senderId = {{ request.user.id }};

    function connectWebSocket() {
        const wsScheme = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const chatSocket = new WebSocket(
            `${wsScheme}${window.location.host}/ws/chat/${roomName}/`
        );

        chatSocket.onopen = function(e) {
            console.log('WebSocket Connected Successfully');
        };

        chatSocket.onerror = function(error) {
            console.error('WebSocket Error:', error);
        };

        chatSocket.onclose = function(e) {
            console.log('WebSocket Closed. Attempting to reconnect in 5 seconds...');
            setTimeout(connectWebSocket, 5000);
        };

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messagesList = document.querySelector('#chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(data.sender_id === senderId ? 'sent' : 'received');
            
            messageDiv.innerHTML = `
                <p>${data.message}</p>
                <small>${new Date().toLocaleTimeString()}</small>
            `;
            
            messagesList.appendChild(messageDiv);
            messagesList.scrollTop = messagesList.scrollHeight;
        };

        // Store socket reference
        window.chatSocket = chatSocket;
    }

    // Initial connection
    connectWebSocket();

    // Send message function
    document.querySelector('#chat-message-submit').onclick = function(e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        
        if (message.trim() && window.chatSocket.readyState === WebSocket.OPEN) {
            window.chatSocket.send(JSON.stringify({
                'message': message,
                'sender_id': senderId
            }));
            
            messageInputDom.value = '';
        }
    };
</script>

<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: 80vh;
    max-width: 800px;
    margin: 0 auto;
    background: var(--card-background);
    border-radius: 8px;
    overflow: hidden;
}

.chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    padding: 1rem;
}

.message {
    margin-bottom: 1rem;
    max-width: 70%;
}

.message.sent {
    margin-left: auto;
    background: var(--primary-color);
    color: white;
    border-radius: 1rem 1rem 0 1rem;
    padding: 0.8rem;
}

.message.received {
    margin-right: auto;
    background: var(--card-background);
    border: 1px solid var(--border-color);
    border-radius: 1rem 1rem 1rem 0;
    padding: 0.8rem;
}

.chat-input {
    display: flex;
    padding: 1rem;
    background: var(--background-darker);
    border-top: 1px solid var(--border-color);
}

.chat-input input {
    flex-grow: 1;
    margin-right: 1rem;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    border: 1px solid var(--border-color);
    background: var(--background-dark);
    color: var(--text-primary);
}

.chat-input button {
    padding: 0.5rem 2rem;
    border-radius: 2rem;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
}
</style>
{% endblock %}
